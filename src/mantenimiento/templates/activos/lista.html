{% extends "base.html" %}

{% block title %}Activos - Sistema de Gestión de Mantenimiento{% endblock %}

{% block page_title %}
    <i class="fas fa-cubes me-2"></i>Gestión de Activos
{% endblock %}

{% block page_actions %}
    <a href="{{ url_for('nuevo_activo') }}" class="btn btn-primary">
        <i class="fas fa-plus-circle me-1"></i> Nuevo Activo
    </a>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-list me-2"></i>Lista de Activos
            </div>
            <div class="d-flex
                <div class="input-group input-group-sm" style="max-width: 300px;">
                    <input type="text" class="form-control" placeholder="Buscar activos..." id="buscarActivo">
                    <button class="btn btn-outline-secondary" type="button" id="btnBuscar">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Ubicación</th>
                            <th>Estado</th>
                            <th>Próximo Mantenimiento</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for activo in activos %}
                        <tr>
                            <td>#{{ activo.activo_id }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <i class="fas fa-cube text-primary"></i>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ activo.nombre }}</div>
                                        <small class="text-muted">{{ activo.criticidad }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ activo.ubicacion or 'No especificada' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if activo.estado == 'Operativo' else 'warning' if activo.estado == 'En Mantenimiento' else 'danger' }}">
                                    {{ activo.estado }}
                                </span>
                            </td>
                            <td>
                                {% if activo.proximo_mantenimiento %}
                                    {{ activo.proximo_mantenimiento.strftime('%d/%m/%Y') }}
                                    <div class="text-muted small">
                                        {% set dias_restantes = (activo.proximo_mantenimiento - now).days %}
                                        {% if dias_restantes > 30 %}
                                            (En {{ (dias_restantes / 30)|round|int }} meses)
                                        {% elif dias_restantes > 0 %}
                                            (En {{ dias_restantes }} días)
                                        {% elif dias_restantes == 0 %}
                                            (Hoy)
                                        {% else %}
                                            (Vencido hace {{ -dias_restantes }} días)
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">No programado</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('ver_activo', activo_id=activo.activo_id) }}" 
                                       class="btn btn-outline-primary"
                                       data-bs-toggle="tooltip" 
                                       title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="#" 
                                       class="btn btn-outline-secondary"
                                       data-bs-toggle="tooltip" 
                                       title="Editar activo">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-outline-danger"
                                            data-bs-toggle="tooltip" 
                                            title="Eliminar activo"
                                            onclick="confirmarEliminar({{ activo.activo_id }})">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p class="mb-0">No se encontraron activos registrados</p>
                                    <a href="{{ url_for('nuevo_activo') }}" class="btn btn-primary mt-3">
                                        <i class="fas fa-plus-circle me-1"></i> Agregar un activo
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            {% if activos and activos|length > 0 %}
            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                <div class="text-muted small">
                    Mostrando {{ activos|length }} de {{ total_activos }} activos
                </div>
                <nav aria-label="Paginación">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item {% if pagina_actual <= 1 %}disabled{% endif %}">
                            <a class="page-link" href="?pagina={{ pagina_actual - 1 }}" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        
                        {% for p in range(1, total_paginas + 1) %}
                            <li class="page-item {% if p == pagina_actual %}active{% endif %}">
                                <a class="page-link" href="?pagina={{ p }}">{{ p }}</a>
                            </li>
                        {% endfor %}
                        
                        <li class="page-item {% if pagina_actual >= total_paginas %}disabled{% endif %}">
                            <a class="page-link" href="?pagina={{ pagina_actual + 1 }}" aria-label="Siguiente">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Modal de confirmación de eliminación -->
    <div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirmar eliminación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar este activo? Esta acción no se puede deshacer.</p>
                    <p class="mb-0"><strong>Nota:</strong> Si el activo tiene registros asociados (fallas, órdenes de trabajo), no podrá ser eliminado.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <form id="formEliminar" method="POST" action="">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt me-1"></i> Eliminar
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Activar tooltips
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Manejar búsqueda
        const buscarInput = document.getElementById('buscarActivo');
        const btnBuscar = document.getElementById('btnBuscar');
        
        if (buscarInput && btnBuscar) {
            btnBuscar.addEventListener('click', function() {
                const termino = buscarInput.value.trim();
                if (termino) {
                    window.location.href = `{{ url_for('listar_activos') }}?buscar=${encodeURIComponent(termino)}`;
                }
            });
            
            buscarInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    btnBuscar.click();
                }
            });
        }
    });
    
    // Función para confirmar eliminación
    function confirmarEliminar(activoId) {
        const form = document.getElementById('formEliminar');
        if (form) {
            form.action = `/activos/${activoId}/eliminar`;
            const modal = new bootstrap.Modal(document.getElementById('modalEliminar'));
            modal.show();
        }
    }
</script>
{% endblock %}
